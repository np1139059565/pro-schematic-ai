# ç™»å½•ç³»ç»Ÿé€»è¾‘æ€ç»´å¯¼å›¾

## ğŸ“‹ æ•´ä½“æ¶æ„

```
ç™»å½•ç³»ç»Ÿ
â”œâ”€â”€ å‰ç«¯ (app.js)
â”‚   â”œâ”€â”€ å¯†ç å¤„ç†
â”‚   â”œâ”€â”€ å‡­è¯ç®¡ç†
â”‚   â”œâ”€â”€ ç™»å½•æµç¨‹
â”‚   â””â”€â”€ çŠ¶æ€ç®¡ç†
â”œâ”€â”€ åç«¯ (cserver.py)
â”‚   â”œâ”€â”€ ç”¨æˆ·éªŒè¯
â”‚   â”œâ”€â”€ å‡­è¯ç”Ÿæˆ
â”‚   â””â”€â”€ æ¥å£è·¯ç”±
â””â”€â”€ æ•°æ®åº“ (db.py)
    â”œâ”€â”€ å‡­è¯ç”Ÿæˆ
    â”œâ”€â”€ å‡­è¯éªŒè¯
    â””â”€â”€ å¯†ç éªŒè¯
```

---

## ğŸ” å¯†ç å¤„ç†æµç¨‹

### å‰ç«¯å¯†ç å“ˆå¸Œ
```
ç”¨æˆ·è¾“å…¥å¯†ç 
    â†“
hashPassword()
    â†“
Web Crypto API (SHA-256)
    â†“
è¿”å›å“ˆå¸Œå€¼ (hex string)
    â†“
ä¼ è¾“åˆ°åç«¯ (password_hash)
```

**å…³é”®ä»£ç ï¼š**
- `hashPassword(password)` - ä½¿ç”¨ Web Crypto API è®¡ç®— SHA256
- å¯†ç æ˜æ–‡**æ°¸ä¸ä¼ è¾“**ï¼Œåªä¼ è¾“å“ˆå¸Œå€¼

---

## ğŸ« å‡­è¯ç³»ç»Ÿ

### å‡­è¯ç”Ÿæˆ (åç«¯)
```
get_current_time_key()
    â†“
å½“å‰æ—¶é—´ â†’ åˆ†é’Ÿå‘ä¸‹å–æ•´åˆ°5çš„å€æ•°
    â†“
æ ¼å¼: "yyyy-mm-dd hh:mm" (å¦‚: "2025-12-21 22:25")
    â†“
generate_voucher(password_hash, time_str)
    â†“
SHA256("æ—¶é—´å­—ç¬¦ä¸²:å¯†ç å“ˆå¸Œ")
    â†“
è¿”å›å‡­è¯ (64ä½hexå­—ç¬¦ä¸²)
```

### å‡­è¯éªŒè¯ (åç«¯)
```
verify_voucher(voucher, password_hash)
    â†“
è·å–å½“å‰æ—¶é—´é”® (åˆ†é’Ÿä¸º5çš„å€æ•°)
    â†“
éªŒè¯å½“å‰æ—¶é—´å‡­è¯
    â”œâ”€â”€ åŒ¹é… â†’ è¿”å› True
    â””â”€â”€ ä¸åŒ¹é… â†’ éªŒè¯ä¸Šä¸€ä¸ª5åˆ†é’Ÿå‡­è¯
        â”œâ”€â”€ åŒ¹é… â†’ è¿”å› True
        â””â”€â”€ ä¸åŒ¹é… â†’ è¿”å› False
```

**ç‰¹ç‚¹ï¼š**
- å‡­è¯æ¯5åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
- æ”¯æŒå½“å‰å’Œä¸Šä¸€ä¸ª5åˆ†é’Ÿçª—å£
- åŸºäºæœåŠ¡å™¨æ—¶é—´ï¼Œä¸ä¾èµ–å®¢æˆ·ç«¯

---

## ğŸš€ åˆå§‹åŒ–æµç¨‹ (å‰ç«¯ onMounted)

```
é¡µé¢åŠ è½½
    â†“
è§£æ URL å‚æ•° (uinfo)
    â”œâ”€â”€ æœ‰ uinfo â†’ userInfoFromUrl.value = è§£æç»“æœ
    â””â”€â”€ æ—  uinfo â†’ userInfoFromUrl.value = null
    â†“
åˆ¤æ–­æµç¨‹
    â”œâ”€â”€ æœ‰ userInfoFromUrl
    â”‚   â””â”€â”€ checkUserStatus()
    â”‚       â”œâ”€â”€ æ£€æŸ¥ localStorage å‡­è¯
    â”‚       â”œâ”€â”€ æœ‰å‡­è¯ä¸” UUID åŒ¹é…
    â”‚       â”‚   â””â”€â”€ loadUserInfo() â†’ æˆåŠŸåˆ™è¿›å…¥
    â”‚       â””â”€â”€ æ— å‡­è¯æˆ–æ— æ•ˆ
    â”‚           â””â”€â”€ è°ƒç”¨ /api/check-user
    â”‚               â”œâ”€â”€ has_password = false â†’ æ˜¾ç¤º"è®¾ç½®å¯†ç "
    â”‚               â””â”€â”€ has_password = true â†’ æ˜¾ç¤º"ç™»å½•"
    â”‚
    â””â”€â”€ æ—  userInfoFromUrl
        â””â”€â”€ loadUserInfo()
            â”œâ”€â”€ æˆåŠŸ â†’ åŠ è½½å¥—é¤
            â””â”€â”€ å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯
```

---

## ğŸ”‘ é¦–æ¬¡è®¾ç½®å¯†ç æµç¨‹

```
ç”¨æˆ·è¾“å…¥å¯†ç  (â‰¥6ä½)
    â†“
å‰ç«¯: hashPassword() â†’ password_hash
    â†“
POST /api/set-password
    Body: {
        uuid, username, avatar,
        password_hash  // å“ˆå¸Œå€¼ï¼Œéæ˜æ–‡
    }
    â†“
åç«¯éªŒè¯
    â”œâ”€â”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å¯†ç 
    â”‚   â””â”€â”€ å·²è®¾ç½® â†’ è¿”å›é”™è¯¯
    â””â”€â”€ åˆ›å»º/æ›´æ–°ç”¨æˆ·
        â”œâ”€â”€ å­˜å‚¨ password_hash
        â””â”€â”€ ç”Ÿæˆå‡­è¯
    â†“
è¿”å›å“åº”
    {
        success: true,
        user_uuid,
        voucher  // ç™»å½•å‡­è¯
    }
    â†“
å‰ç«¯ä¿å­˜å‡­è¯
    â”œâ”€â”€ localStorage.setItem('auth_voucher', voucher)
    â””â”€â”€ localStorage.setItem('user_uuid', user_uuid)
    â†“
å…³é—­ç™»å½•æ¡†
    â†“
loadUserInfo() â†’ loadPackages()
    â†“
è¿›å…¥ä¸»ç•Œé¢
```

---

## ğŸ” ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥å¯†ç 
    â†“
å‰ç«¯: hashPassword() â†’ password_hash
    â†“
POST /api/login
    Body: {
        uuid,
        password_hash  // å“ˆå¸Œå€¼ï¼Œéæ˜æ–‡
    }
    â†“
åç«¯éªŒè¯
    â”œâ”€â”€ æŸ¥è¯¢ç”¨æˆ·
    â”œâ”€â”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å¯†ç 
    â””â”€â”€ verify_password_hash()
        â”œâ”€â”€ å¯†ç é”™è¯¯ â†’ è¿”å› 401
        â””â”€â”€ å¯†ç æ­£ç¡® â†’ ç”Ÿæˆå‡­è¯
    â†“
è¿”å›å“åº”
    {
        success: true,
        user_uuid,
        username,
        voucher  // ç™»å½•å‡­è¯
    }
    â†“
å‰ç«¯ä¿å­˜å‡­è¯
    â”œâ”€â”€ localStorage.setItem('auth_voucher', voucher)
    â””â”€â”€ localStorage.setItem('user_uuid', user_uuid)
    â†“
å…³é—­ç™»å½•æ¡†
    â†“
loadUserInfo() â†’ loadPackages()
    â†“
è¿›å…¥ä¸»ç•Œé¢
```

---

## ğŸ“¥ åŠ è½½ç”¨æˆ·ä¿¡æ¯æµç¨‹

```
loadUserInfo()
    â†“
getAuthHeaders()
    â”œâ”€â”€ ä» localStorage è¯»å–å‡­è¯
    â””â”€â”€ è®¾ç½®è¯·æ±‚å¤´
        â”œâ”€â”€ X-Auth-Voucher: voucher
        â””â”€â”€ X-User-Uuid: user_uuid
    â†“
GET /api/user
    Headers: {
        X-Auth-Voucher: voucher,
        X-User-Uuid: user_uuid
    }
    â†“
åç«¯éªŒè¯ (@login_required)
    â”œâ”€â”€ ä»è¯·æ±‚å¤´è·å–å‡­è¯
    â”œâ”€â”€ æŸ¥è¯¢ç”¨æˆ· password_hash
    â””â”€â”€ verify_voucher()
        â”œâ”€â”€ éªŒè¯æˆåŠŸ â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯
        â””â”€â”€ éªŒè¯å¤±è´¥ â†’ è¿”å› 401 (need_login: true)
    â†“
å‰ç«¯å¤„ç†å“åº”
    â”œâ”€â”€ æˆåŠŸ (200)
    â”‚   â””â”€â”€ userInfo.value = data
    â”‚       â””â”€â”€ è¿›å…¥ä¸»ç•Œé¢
    â”‚
    â””â”€â”€ å¤±è´¥ (401, need_login)
        â””â”€â”€ refreshVoucherIfNeeded()
            â”œâ”€â”€ åˆ·æ–°æˆåŠŸ
            â”‚   â””â”€â”€ é‡è¯• loadUserInfo()
            â””â”€â”€ åˆ·æ–°å¤±è´¥
                â”œâ”€â”€ clearAuthInfo()
                â””â”€â”€ æ˜¾ç¤ºç™»å½•æ¡†
```

---

## ğŸ”„ å‡­è¯åˆ·æ–°æµç¨‹

```
refreshVoucherIfNeeded()
    â†“
ä» localStorage è¯»å–å‡­è¯
    â”œâ”€â”€ voucher
    â””â”€â”€ user_uuid
    â†“
POST /api/refresh-voucher
    Body: {
        voucher,
        user_uuid
    }
    â†“
åç«¯éªŒè¯
    â”œâ”€â”€ æŸ¥è¯¢ç”¨æˆ· password_hash
    â””â”€â”€ verify_voucher()
        â”œâ”€â”€ éªŒè¯æˆåŠŸ
        â”‚   â””â”€â”€ ç”Ÿæˆæ–°å‡­è¯ (å½“å‰æ—¶é—´)
        â”‚       â””â”€â”€ è¿”å›æ–°å‡­è¯
        â””â”€â”€ éªŒè¯å¤±è´¥
            â””â”€â”€ è¿”å› 401
    â†“
å‰ç«¯å¤„ç†
    â”œâ”€â”€ åˆ·æ–°æˆåŠŸ
    â”‚   â””â”€â”€ ä¿å­˜æ–°å‡­è¯åˆ° localStorage
    â”‚       â””â”€â”€ è¿”å› true
    â””â”€â”€ åˆ·æ–°å¤±è´¥
        â””â”€â”€ è¿”å› false
```

---

## ğŸ›¡ï¸ åç«¯éªŒè¯è£…é¥°å™¨

```
@login_required
    â†“
ä»è¯·æ±‚å¤´è·å–
    â”œâ”€â”€ X-Auth-Voucher: voucher
    â””â”€â”€ X-User-Uuid: user_uuid
    â†“
éªŒè¯å‚æ•°
    â”œâ”€â”€ ç¼ºå°‘å‚æ•° â†’ è¿”å› 401
    â””â”€â”€ å‚æ•°å®Œæ•´ â†’ ç»§ç»­
    â†“
æŸ¥è¯¢ç”¨æˆ·
    â”œâ”€â”€ ç”¨æˆ·ä¸å­˜åœ¨ â†’ è¿”å› 401
    â””â”€â”€ ç”¨æˆ·å­˜åœ¨ â†’ ç»§ç»­
    â†“
verify_voucher(voucher, password_hash)
    â”œâ”€â”€ éªŒè¯æˆåŠŸ
    â”‚   â””â”€â”€ request.user_uuid = user_uuid
    â”‚       â””â”€â”€ æ‰§è¡Œè¢«è£…é¥°çš„å‡½æ•°
    â””â”€â”€ éªŒè¯å¤±è´¥
        â””â”€â”€ è¿”å› 401 (need_login: true)
```

---

## ğŸ” æ£€æŸ¥ç”¨æˆ·çŠ¶æ€æµç¨‹

```
checkUserStatus()
    â†“
æ£€æŸ¥ userInfoFromUrl
    â”œâ”€â”€ ä¸å­˜åœ¨ â†’ æ˜¾ç¤ºé”™è¯¯
    â””â”€â”€ å­˜åœ¨ â†’ ç»§ç»­
    â†“
æ£€æŸ¥ localStorage å‡­è¯
    â”œâ”€â”€ æœ‰å‡­è¯ä¸” UUID åŒ¹é…
    â”‚   â””â”€â”€ loadUserInfo()
    â”‚       â”œâ”€â”€ æˆåŠŸ â†’ åŠ è½½å¥—é¤ â†’ è¿”å›
    â”‚       â””â”€â”€ å¤±è´¥ â†’ ç»§ç»­
    â””â”€â”€ æ— å‡­è¯æˆ– UUID ä¸åŒ¹é…
        â””â”€â”€ ç»§ç»­
    â†“
GET /api/check-user?uuid=xxx
    â†“
åç«¯è¿”å›
    {
        exists: true,
        has_password: true/false,
        username,
        avatar
    }
    â†“
å‰ç«¯å¤„ç†
    â”œâ”€â”€ has_password = false
    â”‚   â””â”€â”€ isFirstTime = true
    â”‚       â””â”€â”€ æ˜¾ç¤º"è®¾ç½®å¯†ç "ç•Œé¢
    â””â”€â”€ has_password = true
        â””â”€â”€ isFirstTime = false
            â””â”€â”€ æ˜¾ç¤º"ç™»å½•"ç•Œé¢
```

---

## ğŸ“Š æ•°æ®æµå›¾

### å‡­è¯å­˜å‚¨
```
å‰ç«¯ localStorage
â”œâ”€â”€ auth_voucher: "64ä½hexå­—ç¬¦ä¸²"
â””â”€â”€ user_uuid: "ç”¨æˆ·UUID"
```

### è¯·æ±‚å¤´æ ¼å¼
```
GET/POST è¯·æ±‚
Headers: {
    X-Auth-Voucher: "å‡­è¯å€¼",
    X-User-Uuid: "ç”¨æˆ·UUID"
}
```

### æ—¶é—´é”®æ ¼å¼
```
æ—¶é—´é”®ç”Ÿæˆè§„åˆ™:
- å½“å‰æ—¶é—´: 2025-12-21 22:27:35
- å‘ä¸‹å–æ•´: 2025-12-21 22:25
- æ ¼å¼: "yyyy-mm-dd hh:mm"
```

---

## âš ï¸ é”™è¯¯å¤„ç†

### å‰ç«¯é”™è¯¯å¤„ç†
```
å¯†ç é”™è¯¯
    â””â”€â”€ loginError.value = "å¯†ç é”™è¯¯"

å‡­è¯è¿‡æœŸ
    â”œâ”€â”€ å°è¯•åˆ·æ–°å‡­è¯
    â”œâ”€â”€ åˆ·æ–°æˆåŠŸ â†’ é‡è¯•è¯·æ±‚
    â””â”€â”€ åˆ·æ–°å¤±è´¥ â†’ æ¸…é™¤å‡­è¯ â†’ æ˜¾ç¤ºç™»å½•æ¡†

ç½‘ç»œé”™è¯¯
    â””â”€â”€ loginError.value = "ç½‘ç»œé”™è¯¯ï¼šxxx"

ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯
    â””â”€â”€ hasUserInfoError.value = true
```

### åç«¯é”™è¯¯å¤„ç†
```
ç¼ºå°‘å‚æ•° â†’ 400
ç”¨æˆ·ä¸å­˜åœ¨ â†’ 404
å¯†ç é”™è¯¯ â†’ 401
å‡­è¯æ— æ•ˆ â†’ 401 (need_login: true)
ç”¨æˆ·æœªè®¾ç½®å¯†ç  â†’ 400
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **å¯†ç ä¸ä¼ è¾“æ˜æ–‡**
   - å‰ç«¯è®¡ç®— SHA256 å“ˆå¸Œ
   - åªä¼ è¾“å“ˆå¸Œå€¼

2. **åŸºäºæ—¶é—´çš„å‡­è¯**
   - æ¯5åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
   - æ”¯æŒå½“å‰å’Œä¸Šä¸€ä¸ª5åˆ†é’Ÿçª—å£

3. **å‡­è¯è‡ªåŠ¨åˆ·æ–°**
   - å‡­è¯è¿‡æœŸæ—¶è‡ªåŠ¨å°è¯•åˆ·æ–°
   - åˆ·æ–°å¤±è´¥æ‰è¦æ±‚é‡æ–°ç™»å½•

4. **æœåŠ¡å™¨æ—¶é—´éªŒè¯**
   - å‡­è¯éªŒè¯åŸºäºæœåŠ¡å™¨æ—¶é—´
   - ä¸ä¾èµ–å®¢æˆ·ç«¯æ—¶é—´

---

## ğŸ“ å…³é”®å‡½æ•°æ¸…å•

### å‰ç«¯ (app.js)
- `hashPassword(password)` - å¯†ç å“ˆå¸Œ
- `getAuthVoucher()` - è·å–å‡­è¯
- `getUserUuid()` - è·å–ç”¨æˆ·UUID
- `saveAuthInfo(voucher, userUuid)` - ä¿å­˜å‡­è¯
- `clearAuthInfo()` - æ¸…é™¤å‡­è¯
- `refreshVoucherIfNeeded()` - åˆ·æ–°å‡­è¯
- `getAuthHeaders()` - è·å–è®¤è¯è¯·æ±‚å¤´
- `checkUserStatus()` - æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
- `handleLoginOrSetPassword()` - å¤„ç†ç™»å½•/è®¾ç½®å¯†ç 
- `loadUserInfo()` - åŠ è½½ç”¨æˆ·ä¿¡æ¯

### åç«¯ (cserver.py)
- `get_current_time_key()` - è·å–å½“å‰æ—¶é—´é”®
- `@login_required` - ç™»å½•éªŒè¯è£…é¥°å™¨
- `set_password()` - è®¾ç½®å¯†ç æ¥å£
- `login()` - ç™»å½•æ¥å£
- `check_user()` - æ£€æŸ¥ç”¨æˆ·æ¥å£
- `refresh_voucher()` - åˆ·æ–°å‡­è¯æ¥å£

### æ•°æ®åº“ (db.py)
- `generate_voucher(password_hash, time_str)` - ç”Ÿæˆå‡­è¯
- `verify_voucher(voucher, password_hash)` - éªŒè¯å‡­è¯
- `verify_password_hash()` - éªŒè¯å¯†ç å“ˆå¸Œ
- `hash_password()` - å¯†ç å“ˆå¸Œï¼ˆåç«¯å¤‡ç”¨ï¼‰

---

## ğŸ¯ æ ¸å¿ƒæµç¨‹æ€»ç»“

1. **é¦–æ¬¡è®¿é—®** â†’ è§£æURLå‚æ•° â†’ æ£€æŸ¥å‡­è¯ â†’ æ— å‡­è¯åˆ™æ˜¾ç¤ºç™»å½•æ¡†
2. **è®¾ç½®å¯†ç ** â†’ å‰ç«¯å“ˆå¸Œ â†’ åç«¯å­˜å‚¨ â†’ ç”Ÿæˆå‡­è¯ â†’ ä¿å­˜å‡­è¯ â†’ è¿›å…¥ç•Œé¢
3. **ç™»å½•** â†’ å‰ç«¯å“ˆå¸Œ â†’ åç«¯éªŒè¯ â†’ ç”Ÿæˆå‡­è¯ â†’ ä¿å­˜å‡­è¯ â†’ è¿›å…¥ç•Œé¢
4. **åˆ·æ–°é¡µé¢** â†’ æ£€æŸ¥å‡­è¯ â†’ ä½¿ç”¨å‡­è¯åŠ è½½ â†’ æˆåŠŸåˆ™è¿›å…¥ï¼Œå¤±è´¥åˆ™åˆ·æ–°å‡­è¯
5. **å‡­è¯è¿‡æœŸ** â†’ è‡ªåŠ¨åˆ·æ–° â†’ åˆ·æ–°æˆåŠŸç»§ç»­ï¼Œå¤±è´¥åˆ™é‡æ–°ç™»å½•

